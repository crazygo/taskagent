# 设计文档：Mediator 驱动的开发与审查闭环架构 (最终版)

## 1. 核心理念

本架构旨在构建一个**主从式 (Primary-Secondary)**、**人机协作 (Human-in-the-loop)** 的高级 Agent 协作体系。

其核心是一个作为总指挥的 **Mediator Agent**，它负责调度**开发 Agent (Coder Agent)** 和**审查 Agent (Reviewer Agent)** 协同工作，完成从接收需求到开发实现，再到持续质量监控的整个软件生命周期闭环。

## 2. 核心组件

#### A. Mediator Agent (总指挥)

*   **定位**: **用户交互接口**与**后台任务总调度中心**。
*   **职责**:
    1.  与用户对话，理解其开发需求或审查指令。
    2.  将开发需求委派给 `Coder Agent`，作为一次性的后台任务执行。
    3.  调用 `Monitor Module` 的功能来启动或停止持续性的后台审查任务。
    4.  向用户总结和汇报各个后台任务的结果，并能接收和转述 `Monitor Module` 主动推送的警报。
*   **工具与指令**:
    *   **开发指令**: `/bg:coder_agent <需求描述>` - 用于启动一个一次性的开发任务。
    *   **审查工具**:
        *   `task_check.run`: 调用 `Monitor Module` 的 `start()` 方法，启动后台审查循环。
        *   `task_check.stop`: 调用 `Monitor Module` 的 `stop()` 方法。
        *   `task_check.status`: 调用 `Monitor Module` 的 `getStatus()` 方法，获取最新的审查报告。

#### B. Coder Agent (开发者)

*   **定位**: **后台开发者 (一次性任务)**。
*   **职责**: 接收到 Mediator 派发的具体开发需求后，在后台执行代码编写、修改、提交等一系列开发操作。任务完成后，它会向 Mediator 报告结果。

#### C. Monitor Module (调度器)

*   **定位**: **后台质量监控调度器 (非 Agent)**。这是一个普通的 TypeScript 模块，负责定时循环和逻辑判断。
*   **职责**:
    1.  **管理定时循环**: 内部包含一个 `setInterval` 定时器，负责按时启动审查任务。
    2.  **调用 Reviewer Agent**: 在每个循环周期，它会调用 `Reviewer Agent` 来完成一次审查工作。
    3.  **解析与决策**: 收到审查报告后，进行解析和判断。
    4.  **主动推送**: 如果发现严重问题，会主动通过 `EventBus` 向主界面推送警报。

#### D. Reviewer Agent (审查者)

*   **定位**: **一次性的报告生成器**。
*   **职责**: 接收 `Monitor` 模块的调用，通过编排其子 Agent (`@specs_breakdown`, `@task_log`, `@git_diff`) 来执行一次完整的、深入的审查，并生成一份结构化的审查报告。它本身不包含任何循环逻辑。

## 3. 完整闭环工作流 (最终版 ASCII 图)

```
+-------+                                +------------------------------------------------------+
|       |                                |  A. Mediator Agent (总指挥)                          |
|  用户  |                                |  (解析指令，调度 Coder 和 Monitor)                   |
+-------+                                +------------------------------------------------------+
    |                                                        |
    | "我需要一个新的登录功能"                                   |
    +------------------------------------------------------->| (解析为 /bg:coder_agent 指令)
    |                                                        |
    | (启动后台开发任务)                                       |
    |                                                        ▼
    |                                +------------------------------------------------------+
    |                                |  B. Coder Agent (开发者)                             |
    |                                |  (执行一次性开发任务...)                             |
    |                                +------------------------------------------------------+
    |                                                        |
    | (开发完成)                                             |
    |                                                        |
    |               "登录功能已开发完成"                       |
    |<-------------------------------------------------------+
    |
    | "很好，现在开始对项目进行持续审查"
    +------------------------------------------------------->| (触发 task_check.run)
    |                                                        |
    |                                                        | .start()
    |                                                        ▼
    |                        +------------------------------------------------------------------+
    |                        | C. Monitor Module (后台调度器)                                   |
    |                        |                                                                  |
    |                        |   ↻ 定时循环，调用 Reviewer Agent 并解析报告                     |
    |                        |      |                                                           |
    |                        |      +------> D. Reviewer Agent (执行一次性审查)                  |
    |                        |                                                                  |
    |                        |   (如果发现严重问题，主动推送到 Mediator)                        |
    |                        +------------------------------------------------------------------+
    |                                                        |         ▲
    | "当前审查状态如何？"                                       |         | (触发 task_check.status)
    +------------------------------------------------------->|         |
    |                                                        |         |
    |               "最新的审查报告显示一切正常..."                |
    |<-------------------------------------------------------+---------+
```

## 4. 架构亮点

*   **职责清晰**: Mediator 负责“管理和沟通”，Coder 负责“创造”，Monitor 负责“调度”，Reviewer 负责“监督”。各组件职责单一，高度解耦。
*   **流程闭环**: 完美地覆盖了“**提需求 -> 写代码 -> 监控质量**”的软件开发核心流程。
*   **智能与自动化**: 系统不仅能自动化执行任务，`Monitor` 模块还具备了主动发现并上报严重问题的“智能”，变被动查询为主动告警。
*   **可控性与协作**: 用户始终拥有最高控制权，可以通过 Mediator 与后台任务协作，实现灵活、高效的人机交互。