# Phase 1.5 执行计划

**日期**: 2025-11-04 23:35  
**目标**: 更新路径 + 迁移测试结构（不要求通过）  
**预计时间**: 1-2 小时  

---

## 🎯 核心原则

> **当前代码跑不通 → 测试不需要 pass → 但要保留测试结构和路径**

1. ✅ 优先更新 import 路径，确保代码结构正确
2. ✅ 迁移测试用例和测试路径，保留测试框架
3. ⏳ 稍后再确保测试 pass（在代码稳定后）

---

## 📋 任务清单

### P0 - 立即执行

#### Task 1: 更新 packages/cli import 路径
**目标**: 所有导入从 `../../src/` 改为 `@taskagent/*`

**关键文件**:
- `packages/cli/main.tsx` (原 ui.tsx)
- `packages/cli/components/*.tsx`
- `packages/cli/store/*.ts`
- `packages/cli/hooks/*.ts`
- `packages/cli/workflow/*.ts`

**路径映射**:
```typescript
// Before
import { runClaudeStream } from '../../src/agents/runtime/runClaudeStream';
import type { Message } from '../../src/types';

// After
import { runClaudeStream } from '@taskagent/agents/runtime/runClaudeStream';
import type { Message } from '@taskagent/core/types/Message';
```

**预计时间**: 30 分钟

---

#### Task 2: 更新 packages/agents import 路径
**目标**: 调整内部导入路径

**关键文件**:
- `packages/agents/runtime/*.ts`
- `packages/agents/story/**/*.ts`
- `packages/agents/glossary/**/*.ts`
- `packages/agents/ui-review/**/*.ts`
- `packages/agents/monitor/**/*.ts`

**路径映射**:
```typescript
// Before
import { runClaudeStream } from '../../agent/runtime/runClaudeStream';

// After
import { runClaudeStream } from '../runtime/runClaudeStream';
// or
import { runClaudeStream } from '@taskagent/agents/runtime/runClaudeStream';
```

**预计时间**: 20 分钟

---

#### Task 3: 迁移测试结构
**目标**: 保留测试用例，更新路径，但不要求 pass

**关键工作**:

1. **保留现有测试**:
   - ✅ `tests/**/*.test.ts` 原样保留
   - ✅ `tests/helpers/run-command.ts` 保留

2. **更新测试路径**:
   ```typescript
   // tests/story.test.ts
   // Before
   import { ... } from '../src/agents/story/...';
   
   // After
   import { ... } from '@taskagent/agents/story/...';
   ```

3. **更新 vitest.config.ts**:
   ```typescript
   // 可能需要添加 path alias
   export default defineConfig({
     test: {
       // ... existing config
     },
     resolve: {
       alias: {
         '@taskagent/core': '/packages/core',
         '@taskagent/agents': '/packages/agents',
         '@taskagent/cli': '/packages/cli',
       }
     }
   });
   ```

4. **package.json scripts 保留**:
   ```json
   {
     "test": "vitest",
     "test:ci": "vitest run",
     "test:story": "yarn start -- --story -p \"Hi\"",
     "test:glossary": "yarn start -- --glossary -p \"Hi\""
   }
   ```

**注意**: 
- ⚠️ 测试现在不需要 pass
- ✅ 只需要结构正确，路径正确
- ⏳ 稍后在代码稳定后确保 pass

**预计时间**: 20 分钟

---

### P1 - 路径更新完成后

#### Task 4: 验证 TypeScript 编译
**目标**: 确保 tsc --noEmit 通过

**验证步骤**:
```bash
cd packages/core && tsc --noEmit
cd packages/agents && tsc --noEmit
cd packages/cli && tsc --noEmit
```

**预期结果**:
- ✅ 无编译错误
- ⚠️ 可能有类型警告（可接受）

**预计时间**: 10 分钟

---

### P2 - 稍后执行（代码稳定后）

#### Task 5: 确保测试 pass
**目标**: 修复测试，确保 CI 通过

**时机**: 
- ✅ Phase 1.5 路径更新完成
- ✅ Phase 2 Event Bus 集成完成
- ✅ 代码可以正常运行

**验证步骤**:
```bash
yarn test:ci
yarn test:story
yarn test:glossary
```

**预计时间**: 1-2 小时（稍后）

---

## 🎯 执行顺序

```
1. 更新 packages/cli import 路径          [30 min] ⏳
   └─> main.tsx, components/, store/, hooks/
   
2. 更新 packages/agents import 路径       [20 min] ⏳
   └─> runtime/, story/, glossary/, ui-review/
   
3. 迁移测试结构（不要求 pass）            [20 min] ⏳
   └─> 更新 tests/ 路径 + vitest.config.ts
   
4. 验证 TypeScript 编译                   [10 min] ⏳
   └─> tsc --noEmit 通过
   
------- Phase 1.5 完成 -------

5. 确保测试 pass（稍后）                  [1-2 hr] 🔜
   └─> 在代码稳定后执行
```

---

## ✅ 完成标准

### Phase 1.5 完成 = 以下 4 项全部完成：

- [ ] packages/cli 所有 import 路径已更新
- [ ] packages/agents 所有 import 路径已更新
- [ ] 测试结构已迁移（路径已更新）
- [ ] TypeScript 编译通过（tsc --noEmit）

### ⚠️ 不要求：
- ❌ 测试不需要 pass
- ❌ 应用不需要能运行
- ❌ CI 不需要通过

### ✅ Phase 1.5 完成后：
- 代码结构清晰
- 路径正确
- 可以开始 Phase 2 (Event Bus 集成)
- 稍后再修复测试

---

## 📊 预期成果

**完成后的状态**:
```
✅ Monorepo 结构正确
✅ Import 路径正确
✅ TypeScript 编译通过
✅ 测试结构正确（路径已更新）
⏳ 测试 pass（稍后）
⏳ 应用运行（Phase 2 后）
```

**时间线**:
- Phase 1.5 完成: 2025-11-05 凌晨 1:00
- Phase 2 开始: 2025-11-05 凌晨 1:00
- Phase 2 完成: 2025-11-05 上午 3:00
- 测试 pass: 2025-11-05 上午（Phase 2 后）

---

**计划生成时间**: 2025-11-04 23:35  
**下一步**: 开始 Task 1 (更新 packages/cli import 路径)

