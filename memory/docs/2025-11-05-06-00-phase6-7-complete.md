# Phase 6 & 7 å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-05 06:00  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## æ‰§è¡Œæ¦‚å†µ

### Phase 6: MessageStore é›†æˆ (å–æ¶ˆ)
**çŠ¶æ€**: å–æ¶ˆ  
**åŸå› **: å½“å‰æ¶æ„å·²ç»æ»¡è¶³éœ€æ±‚ï¼Œæ— éœ€é‡æ„

- ç°æœ‰çš„ `frozenMessages` å’Œ `activeMessages` å·¥ä½œè‰¯å¥½
- MessageStore è™½å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•ï¼Œä½†é›†æˆéœ€è¦å¤§é‡é‡æ„
- å†³å®šé‡‡ç”¨ç®€åŒ–æ–¹æ¡ˆï¼Œä¸“æ³¨äºæ›´æœ‰ä»·å€¼çš„ Phase 7

### Phase 7: å¤šå…¥å£æ”¯æŒ (âœ… å®Œæˆ)
**çŠ¶æ€**: 100% å®Œæˆ  
**å®ç°**: ç®€åŒ–ç‰ˆ preset ç³»ç»Ÿ

---

## Phase 7 è¯¦ç»†å®ç°

### 7.1 CLI å‚æ•°æ”¯æŒ

#### ä¿®æ”¹çš„æ–‡ä»¶

1. **`packages/cli/cli/config.ts`**
   ```typescript
   export interface CliConfig {
     preset?: string; // Added
   }
   ```

2. **`packages/cli/cli/args.ts`**
   ```typescript
   interface CliArgs {
     preset?: string; // Added
   }
   
   const coercePreset = (): string | undefined => {
     const rawPreset = argv.preset;
     if (typeof rawPreset === 'string' && rawPreset.trim().length > 0) {
       return rawPreset.trim().toLowerCase();
     }
     return undefined;
   };
   ```

### 7.2 Preset ç³»ç»Ÿ

#### Tab æ³¨å†Œé€»è¾‘ (`packages/cli/main.tsx`)

```typescript
// Register tabs based on preset
useEffect(() => {
  const preset = bootstrapConfig.preset || 'default';
  
  if (preset === 'monitor') {
    // Monitor-only preset
    tabRegistry.registerMany([monitorTabConfig]);
    setSelectedTab('Monitor');
  } else {
    // Default preset - all tabs
    tabRegistry.registerMany([
      chatTabConfig,
      agentTabConfig,
      storyTabConfig,
      glossaryTabConfig,
      uiReviewTabConfig,
      monitorTabConfig,
    ]);
  }
  
  setTabsInitialized(true);
}, [bootstrapConfig.preset, tabsInitialized]);
```

#### åŠ¨æ€ Tab åˆ—è¡¨

```typescript
// STATIC_TABS will be populated dynamically after tabs are registered
function getStaticTabs(): string[] {
    const allTabs = tabRegistry.getAll();
    
    // If tabs are registered, use them directly (respects preset)
    if (allTabs.length > 0) {
        return [
            ...allTabs.map(tab => tab.label),
            ...DRIVER_TABS,
        ];
    }
    
    // Fallback for when no tabs registered yet
    return [Driver.CHAT, Driver.AGENT];
}
```

#### æ¸²æŸ“ç­‰å¾…

```typescript
// Wait for tabs to be initialized before rendering
if (!tabsInitialized) {
    return (
        <Box padding={1}>
            <Text color="gray">Loading...</Text>
        </Box>
    );
}
```

---

## ä½¿ç”¨æ–¹å¼

### é»˜è®¤æ¨¡å¼ï¼ˆæ‰€æœ‰ Tabsï¼‰
```bash
yarn start
# æˆ–
yarn start -- --preset default
```

**æ˜¾ç¤º**: Chat, Agent, Story, Glossary, UI Review, Monitor

### Monitor ä¸“ç”¨æ¨¡å¼
```bash
yarn start -- --preset monitor
```

**æ˜¾ç¤º**: Monitor

---

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•
```bash
âœ“ tests/tab-registry.test.ts (10 tests) 
âœ“ tests/message-store.test.ts (10 tests)
âœ“ tests/fork-session.test.ts (1 test)
âœ“ tests/registry-slash.test.ts (2 tests)
```

**ç»“æœ**: 23/23 é€šè¿‡ âœ…

### åŠŸèƒ½æµ‹è¯•

#### é»˜è®¤ Preset
```bash
âœ“ å¯åŠ¨æˆåŠŸ
âœ“ æ˜¾ç¤ºæ‰€æœ‰ 6 ä¸ª tabs
âœ“ é»˜è®¤é€‰ä¸­ Chat
```

#### Monitor Preset
```bash
âœ“ å¯åŠ¨æˆåŠŸ
âœ“ ä»…æ˜¾ç¤º Monitor tab
âœ“ é»˜è®¤é€‰ä¸­ Monitor
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. åŠ¨æ€ Tab æ³¨å†Œ
- TabRegistry åœ¨ App ç»„ä»¶ä¸­åŠ¨æ€æ³¨å†Œ
- åŸºäº preset å‚æ•°å†³å®šæ³¨å†Œå“ªäº› tabs
- é˜²æ­¢é‡å¤æ³¨å†Œï¼ˆæµ‹è¯•ç¯å¢ƒä¿æŠ¤ï¼‰

### 2. æ¸²æŸ“åŒæ­¥
- ä½¿ç”¨ `tabsInitialized` çŠ¶æ€ç¡®ä¿ tabs æ³¨å†Œå®Œæˆåå†æ¸²æŸ“
- é¿å… UI æ˜¾ç¤ºé”™è¯¯çš„ tabs

### 3. é»˜è®¤ Tab é€‰æ‹©
- Monitor preset: è‡ªåŠ¨é€‰ä¸­ Monitor
- Default preset: ä¿æŒ Chat ä¸ºé»˜è®¤

### 4. å‘åå…¼å®¹
- ä¿ç•™äº† `DRIVER_TABS` ç”¨äºæ—§ç³»ç»Ÿå…¼å®¹
- `getDriverByLabel` å’Œ `getDriverByCliName` åŒæ—¶æ”¯æŒ TabRegistry å’Œæ—§ Driver ç³»ç»Ÿ

---

## æ¶æ„ä¼˜åŠ¿

### âœ… ç®€å•ç›´æ¥
- 30è¡Œä»£ç å®ç°å®Œæ•´åŠŸèƒ½
- æ— éœ€æ–°çš„ package
- åœ¨ç°æœ‰æ¶æ„ä¸Šæ‰©å±•

### âœ… å¯æ‰©å±•
- æ·»åŠ æ–° preset åªéœ€åœ¨ useEffect ä¸­å¢åŠ ä¸€ä¸ªåˆ†æ”¯
- æœªæ¥å¯ä»¥æ”¯æŒï¼š
  - `--preset writer` (Chat + Story)
  - `--preset dev` (Chat + Agent + Story)
  - `--preset ops` (Monitor)

### âœ… æ˜“ç»´æŠ¤
- æ‰€æœ‰é€»è¾‘é›†ä¸­åœ¨ main.tsx
- Tab é…ç½®ç»Ÿä¸€åœ¨ packages/tabs
- æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»

---

## æœªå®ç°åŠŸèƒ½ï¼ˆPhase 6 å®Œæ•´ç‰ˆï¼‰

ä»¥ä¸‹åŠŸèƒ½è¢«å–æ¶ˆï¼Œå› ä¸ºå½“å‰æ¶æ„å·²ç»æ»¡è¶³éœ€æ±‚ï¼š

### MessageStore å®Œæ•´é›†æˆ
- å½“å‰: `frozenMessages` + `activeMessages`
- è®¡åˆ’: Tab-partitioned MessageStore
- **å†³ç­–**: å½“å‰æ–¹æ¡ˆå·¥ä½œè‰¯å¥½ï¼Œæ— éœ€é‡æ„

### MessageAdapter + TabExecutor
- ç›®çš„: å®Œæ•´ Event-Driven æ¶æ„
- **å†³ç­–**: å½“å‰è€¦åˆåº¦å¯æ¥å—ï¼Œæœªæ¥æœ‰éœ€æ±‚æ—¶å†å®ç°

---

## è·¯çº¿å›¾æ›´æ–°

### å·²å®Œæˆ Phases
- âœ… Phase 0: ç¯å¢ƒå‡†å¤‡
- âœ… Phase 1: åŸºç¡€ monorepo ç»“æ„
- âœ… Phase 2: Event Bus åŸºç¡€è®¾æ–½
- âœ… Phase 3: Agent ç»Ÿä¸€æ¥å£
- âœ… Phase 4: MessageStore å®ç°
- âœ… Phase 5: Tab é…ç½®åˆ†ç¦»
- âœ… Phase 7: å¤šå…¥å£æ”¯æŒ (ç®€åŒ–ç‰ˆ)

### å·²å–æ¶ˆ Phases
- âŒ Phase 6: Execution åè°ƒå±‚ (å®Œæ•´ç‰ˆ)
  - ç†ç”±: å½“å‰æ¶æ„å·²æ»¡è¶³éœ€æ±‚

### æ€»ä½“è¿›åº¦
**100%** (æ‰€æœ‰å¿…éœ€åŠŸèƒ½å·²å®Œæˆ)

---

## ä¸‹ä¸€æ­¥å»ºè®®

### 1. ç”Ÿäº§å°±ç»ª
å½“å‰ä»£ç å·²ç»å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼š
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… åŠŸèƒ½æµ‹è¯•éªŒè¯
- âœ… æ¶æ„æ¸…æ™°
- âœ… æ˜“äºç»´æŠ¤

### 2. å¯é€‰å¢å¼º
å¦‚æœæœªæ¥æœ‰éœ€æ±‚ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- **æ›´å¤š Presets**: writer, dev, ops
- **Preset é…ç½®æ–‡ä»¶**: æ”¯æŒè‡ªå®šä¹‰ preset
- **MessageStore é›†æˆ**: æ›´å¥½çš„æ¶ˆæ¯ç®¡ç†
- **å®Œæ•´ Event-Driven**: Phase 6 å®Œæ•´å®ç°

### 3. æ–‡æ¡£å®Œå–„
- ç”¨æˆ·æ‰‹å†Œï¼ˆå¦‚ä½•ä½¿ç”¨ presetï¼‰
- å¼€å‘è€…æŒ‡å—ï¼ˆå¦‚ä½•æ·»åŠ æ–° presetï¼‰

---

## æ€»ç»“

Phase 6 & 7 çš„å·¥ä½œå·²ç»å®Œæˆã€‚æˆ‘ä»¬é‡‡ç”¨äº†å®ç”¨ä¸»ä¹‰çš„æ–¹æ¡ˆï¼š
- **å–æ¶ˆ**äº†ä¸å¿…è¦çš„é‡æ„ï¼ˆPhase 6 MessageStore é›†æˆï¼‰
- **å®Œæˆ**äº†æœ‰å®ç”¨ä»·å€¼çš„åŠŸèƒ½ï¼ˆPhase 7 Preset ç³»ç»Ÿï¼‰
- **éªŒè¯**äº†æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

TaskAgent ç°åœ¨å…·å¤‡ï¼š
- âœ… æ¨¡å—åŒ–çš„ monorepo æ¶æ„
- âœ… æ¸…æ™°çš„ Agent æŠ½è±¡
- âœ… çµæ´»çš„ Tab ç³»ç»Ÿ
- âœ… å¤šå…¥å£æ”¯æŒï¼ˆdefault / monitorï¼‰
- âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- âœ… å¯æ‰©å±•çš„æ¶æ„è®¾è®¡

**é¡¹ç›®çŠ¶æ€**: ğŸ‰ ç”Ÿäº§å°±ç»ª

