# é‡æ„è·¯çº¿å›¾ v2.0 - ç¡®è®¤å†³ç­–æ€»ç»“

**æ—¥æœŸ**: 2025-11-04 18:00  
**çŠ¶æ€**: âœ… å·²ç¡®è®¤ï¼Œæ— æ­§ä¹‰  
**æ–‡æ¡£**: `memory/docs/2025-11-04-refactor-roadmap-v2.md`

---

## ğŸ“‹ å·²ç¡®è®¤çš„å…³é”®å†³ç­–

### 1ï¸âƒ£ æ„å»ºå·¥å…·é“¾

**å†³ç­–**: B - ç›´æ¥ä½¿ç”¨ `tsc`ï¼Œä¸ç°æœ‰æ–¹å¼ä¸€è‡´

**å®æ–½**:
- âœ… ç§»é™¤ `turbo.json`
- âœ… ä¿æŒç°æœ‰æ„å»ºæµç¨‹
- âœ… å‡å°‘é…ç½®å¤æ‚åº¦

---

### 2ï¸âƒ£ Tab ç±»å‹å®šä¹‰

**å†³ç­–**: B - ç®€åŒ–ä¸ºä¸¤ç§ç±»å‹

**æ–°å®šä¹‰**:
```typescript
type: 'chat' | 'agent'
```

**è¯´æ˜**:
- `'chat'` = Vercel AI SDKï¼ˆç®€å•å¯¹è¯ï¼‰
- `'agent'` = Claude Agent SDKï¼ˆåŒ…æ‹¬çº¯ Agent å’Œç‰¹å®š Driver Agentï¼‰
- âœ… æ¶ˆé™¤ `'agent-driven'` å†—ä½™æ¦‚å¿µ

**ç†ç”±**: Agent æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª drivenï¼ˆçº¯ç²¹çš„æ—  appended system çš„ Agentï¼‰ï¼ŒStory ç­‰æ˜¯å…¶ä»–çš„ drivenï¼Œæœ¬è´¨ä¸Šå’Œã€Agent tabã€‘å¹³è¡Œçš„

---

### 3ï¸âƒ£ æ€§èƒ½æŒ‡æ ‡

**å†³ç­–**: æš‚ä¸è€ƒè™‘æ€§èƒ½æµ‹è¯•

**å®æ–½**:
- âœ… åˆ é™¤æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯åŠ¨æ—¶é—´ã€Tab åˆ‡æ¢ã€å†…å­˜å ç”¨ï¼‰
- âœ… åªä¿ç•™åŠŸèƒ½æµ‹è¯•ï¼ˆtest:ci, test:story, test:glossary ç­‰ï¼‰
- âœ… Phase 0 ä» 2 å¤©å‡å°‘åˆ° 1 å¤©
- âœ… æ€»æ—¶é—´ä» 3-4 å‘¨å‡å°‘åˆ° 3 å‘¨

---

### 4ï¸âƒ£ æ¶ˆæ¯ç®¡ç†

**å†³ç­–**: ä¿ç•™ 20 æ¡ï¼Œæ·»åŠ æ¨ªçº¿åˆ†å‰²

**è¯¦ç»†è§„åˆ™**:
```typescript
// ä¸å¯è§ Tab é™åˆ¶æ¶ˆæ¯æ•°é‡ï¼ˆé»˜è®¤ 20 æ¡ï¼Œå¯é…ç½®ï¼‰
const maxMessages = this.getTabConfig(tabId)?.maxFrozenMessages ?? 20;

// åˆ‡æ¢ Tab æ—¶ï¼Œæ·»åŠ åˆ†éš”çº¿
if (this.currentTabId !== newTabId) {
    newTabMessages.frozen.push({
        id: Date.now(),
        role: 'system',
        content: 'â”€'.repeat(50),  // æ¨ªçº¿åˆ†å‰²
        sourceTabId: newTabId,
        timestamp: Date.now()
    });
}
```

**é…ç½®ç¤ºä¾‹**:
```typescript
storyTabConfig = {
    maxFrozenMessages: 20       // Story ä¿ç•™ 20 æ¡
}

monitorTabConfig = {
    maxFrozenMessages: 100      // Monitor ä¿ç•™ 100 æ¡
}
```

---

### 5ï¸âƒ£ onCompleted/onFailed å¤„ç†

**å†³ç­–**: B - åˆ›å»º eventï¼Œä¸æ˜¯ç‰¹æ®Šæ¶ˆæ¯

**å®æ–½**:
- âœ… `eventBus.emit('agent:completed', ...)`
- âœ… `eventBus.emit('agent:failed', ...)`
- âœ… Event ä¿¡æ¯ä½“ç°å‡ºäº‹ä»¶

**è¯´æ˜**: å®Œæˆ/å¤±è´¥é€šè¿‡ Event Bus ä¼ é€’ï¼ŒUI å±‚å¯è®¢é˜…å¹¶æ˜¾ç¤ºï¼Œä½†ä¸æ˜¯ç‰¹æ®Šçš„ Message å¯¹è±¡

---

### 6ï¸âƒ£ Session ç®¡ç†

**å†³ç­–**: B - å†…å­˜å­˜å‚¨ï¼Œä¸æŒä¹…åŒ–

**è¯¦ç»†è§„åˆ™**:

#### å…¨å±€ Session
- é»˜è®¤æ‰€æœ‰å‰å° Tab **å…±äº«åŒä¸€ä¸ª Session**
- Session ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆ`TabExecutionState`ï¼‰
- é‡å¯åº”ç”¨ä¸¢å¤±
- ä¼˜å…ˆå¤ç”¨ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§

#### Fork Sessionï¼ˆåå°ä»»åŠ¡ï¼‰
- ä½¿ç”¨ `/bg:agent` å‘½ä»¤æ—¶ï¼Œfork å½“å‰ Session
- åå°ä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹çš„ Session IDï¼ˆ**bgtask ä¸“æœ‰**ï¼‰
- å¤–å±‚ä¿æŒåŸæœ‰ Session ID ä¸å˜

**ç¤ºä¾‹**:
```typescript
// å‰å° Tabï¼šå…±äº« Session
Story Tab: session_id = "abc123"
Glossary Tab: session_id = "abc123"  // å…±äº«

// åå°ä»»åŠ¡ï¼šfork Session
/bg:monitor: session_id = "abc123_fork_001"  // fork è‡ª abc123
```

---

### 7ï¸âƒ£ Agent å’Œ Tab ç»‘å®š

**å†³ç­–**: A - å›ºå®šç»‘å®š

**è§„åˆ™**:
- æ¯ä¸ª Tab å›ºå®šç»‘å®šä¸€ä¸ª Agentï¼ˆå¦‚ Story Tab â†’ Story Agentï¼‰
- å¯ä»¥é€šè¿‡ `/fg <agent-id> <prompt>` å‘½ä»¤**å•æ¬¡è§¦å‘**å…¶ä»– Agent
- æ— å‘½ä»¤æ—¶ï¼Œé»˜è®¤ç»‘å®šå…³ç³»ä¸å˜

**ç¤ºä¾‹**:
```bash
# åœ¨ Story tab ç›´æ¥è¾“å…¥ï¼Œä½¿ç”¨ Story Agentï¼ˆé»˜è®¤ç»‘å®šï¼‰
æ•´ç†éœ€æ±‚

# åœ¨ Story tab ä¸´æ—¶ä½¿ç”¨ Glossary Agentï¼ˆå•æ¬¡è§¦å‘ï¼‰
/fg glossary "æŸ¥æ‰¾æœ¯è¯­ 'BDD'"

# ä¸‹æ¬¡å†ç›´æ¥è¾“å…¥ï¼Œä»ç„¶ä½¿ç”¨ Story Agent
ç»§ç»­æ•´ç†éœ€æ±‚
```

---

### 8ï¸âƒ£ æµ‹è¯•è¦†ç›–ç‡

**å†³ç­–**: è¦æ±‚èƒ½è¿‡ç°åœ¨çš„ ci æµ‹è¯•

**å®æ–½**:
- âœ… ç§»é™¤å…·ä½“è¦†ç›–ç‡ç›®æ ‡ï¼ˆ60% â†’ 70%ï¼‰
- âœ… åªè¦æ±‚ç°æœ‰æµ‹è¯•é€šè¿‡

**éªŒæ”¶æ ‡å‡†**:
```bash
yarn test:ci              # å¿…é¡»é€šè¿‡
yarn test:story           # å¿…é¡»é€šè¿‡
yarn test:glossary        # å¿…é¡»é€šè¿‡
yarn e2e:experiment       # å¿…é¡»é€šè¿‡
```

---

### 9ï¸âƒ£ Event ç‰ˆæœ¬æ§åˆ¶

**å†³ç­–**: å›ºå®š 1.0

**å®æ–½**:
```typescript
version: '1.0'  // å›ºå®šï¼Œä¸æ¼”è¿›
```

**è¯´æ˜**: ä¸è€ƒè™‘ç‰ˆæœ¬æ¼”è¿›ï¼Œä¿æŒç®€å•

---

### ğŸ”Ÿ Event Bus é€šé…ç¬¦

**å†³ç­–**: ä¸æ”¯æŒé€šé…ç¬¦è®¢é˜…

**å®æ–½**:
- âœ… åªæ”¯æŒç²¾ç¡®è®¢é˜…ï¼š`eventBus.on('agent:text', handler)`
- âŒ ä¸æ”¯æŒé€šé…ç¬¦ï¼š`eventBus.on('agent:*', handler)`

**ç†ç”±**: ä¿æŒç®€å•ï¼Œéœ€è¦å¤šä¸ªäº‹ä»¶æ—¶æ˜¾å¼è®¢é˜…

---

### 1ï¸âƒ£1ï¸âƒ£ executionMode ä½¿ç”¨åœºæ™¯

**å†³ç­–**: foreground = ä¸»å±å¹•, background = å°åŒºåŸŸ + fork

**è¯¦ç»†è¯´æ˜**:

#### Foreground æ¨¡å¼
- æ¸²æŸ“åˆ°**ä¸»å±å¹•**
- è¿½åŠ æ¶ˆæ¯åˆ°å½“å‰ Tab çš„ frozen/active
- ä¸å…¶ä»–å‰å° Tab **å…±äº« Session**

#### Background æ¨¡å¼
- é€šè¿‡ `/bg:agent` å‘½ä»¤è§¦å‘
- æ¸²æŸ“åˆ°**å°åŒºåŸŸ**ï¼ˆç±»ä¼¼çŠ¶æ€æ ï¼‰
- **Fork Session**ï¼ˆç‹¬ç«‹ä¸Šä¸‹æ–‡ï¼‰
- ä¸å½±å“ä¸»å±å¹•

**ç¤ºä¾‹**:
```typescript
storyTabConfig = {
    executionMode: 'foreground'  // æ¸²æŸ“åˆ°ä¸»å±å¹•
}

// è¿è¡Œæ—¶ï¼š/bg:monitor äº§ç”Ÿ background ä»»åŠ¡
{
    executionMode: 'background',  // æ¸²æŸ“åˆ°å°åŒºåŸŸ
    forkSession: true            // Fork Session
}
```

---

### 1ï¸âƒ£2ï¸âƒ£ å‘½ä»¤ç³»ç»Ÿ

**å†³ç­–**: å…¨å±€å‘½ä»¤ï¼Œä¸å½“å‰ä¿æŒä¸€è‡´

**å‘½ä»¤åˆ—è¡¨**:

#### Tab åˆ‡æ¢
- Tabé”® / Shift+Tab
- æ•°å­—é”®

#### Agent æ‰§è¡Œ
- `/fg <agent-id> <prompt>` - å‰å°å•æ¬¡æ‰§è¡Œ
- `/bg:<agent-id> <prompt>` - åå°æ‰§è¡Œï¼ˆfork sessionï¼‰

#### å…¶ä»–
- `/help`, `/version`, `/quit`

**è¯´æ˜**: å‘½ä»¤åœ¨ä»»ä½• Tab éƒ½å¯ç”¨ï¼Œä¸ç°æœ‰è¡Œä¸ºä¸€è‡´

---

## ğŸ—‚ï¸ æ¶æ„è°ƒæ•´

### Package ç»“æ„ç®€åŒ–

**ç§»é™¤**: `packages/ai-runtime/`

**æ•´åˆåˆ°**: `packages/agents/runtime/`

**åŸå› **: å•åŒ…æ¶æ„ä¸éœ€è¦è¿‡åº¦ç»†åˆ†

**æ–°ç»“æ„**:
```
packages/agents/
â”œâ”€â”€ runtime/             # AI SDK é›†æˆå±‚
â”‚   â”œâ”€â”€ runClaudeStream.ts
â”‚   â”œâ”€â”€ buildPromptAgentStart.ts
â”‚   â””â”€â”€ flows/
â”‚       â””â”€â”€ baseClaudeFlow.ts
â”œâ”€â”€ story/
â”œâ”€â”€ glossary/
â””â”€â”€ monitor/
```

---

## ğŸ“Š å…³é”®æŒ‡æ ‡æ›´æ–°

| ç»´åº¦ | æ›´æ–°å‰ | æ›´æ–°å | å˜åŒ– |
|-----|--------|--------|------|
| **Phase 0 æ—¶é—´** | 2 å¤© | 1 å¤© | â¬‡ï¸ å‡å°‘ 1 å¤© |
| **æ€»æ—¶é—´** | 3-4 å‘¨ | 3 å‘¨ | â¬‡ï¸ å‡å°‘ 1 å‘¨ |
| **Package æ•°é‡** | 7 ä¸ª | 6 ä¸ª | â¬‡ï¸ ç§»é™¤ ai-runtime |
| **Tab ç±»å‹** | 3 ç§ | 2 ç§ | â¬‡ï¸ ç®€åŒ– |
| **æ„å»ºå·¥å…·** | Turbo | tsc | â¬‡ï¸ ç®€åŒ– |
| **æ€§èƒ½æµ‹è¯•** | æœ‰ | æ—  | â¬‡ï¸ åˆ é™¤ |
| **é»˜è®¤æ¶ˆæ¯ä¿ç•™** | 100 æ¡ | 20 æ¡ | â¬‡ï¸ é™ä½å†…å­˜å ç”¨ |

---

## âœ… æ–‡æ¡£æ›´æ–°æ¸…å•

### å·²æ›´æ–°éƒ¨åˆ†

- âœ… ç›®å½•ç»“æ„ï¼ˆç§»é™¤ turbo.json, ai-runtimeï¼‰
- âœ… Tab ç±»å‹å®šä¹‰ï¼ˆç®€åŒ–ä¸º 2 ç§ï¼‰
- âœ… Tab é…ç½®ç¤ºä¾‹ï¼ˆæ›´æ–° type, æ·»åŠ  maxFrozenMessagesï¼‰
- âœ… MessageStore å®ç°ï¼ˆ20 æ¡é™åˆ¶ï¼Œæ¨ªçº¿åˆ†å‰²ï¼‰
- âœ… Phase 0ï¼ˆåˆ é™¤æ€§èƒ½æµ‹è¯•ï¼Œ1 å¤©ï¼‰
- âœ… Phase 1ï¼ˆæ›´æ–°è¿ç§»æ­¥éª¤ï¼‰
- âœ… æ€»æ—¶é—´ä¼°è®¡ï¼ˆ3 å‘¨ï¼‰
- âœ… éªŒæ”¶æ ‡å‡†ï¼ˆç§»é™¤è¦†ç›–ç‡ç›®æ ‡ï¼‰
- âœ… å…³é”®è®¾è®¡å†³ç­–ï¼ˆæ–°å¢ 5-8 é¡¹ï¼‰
- âœ… å‘½ä»¤ç³»ç»Ÿè¯´æ˜ï¼ˆæ–°å¢ç« èŠ‚ï¼‰
- âœ… Session ç®¡ç†ç­–ç•¥ï¼ˆæ–°å¢ç« èŠ‚ï¼‰
- âœ… é™„å½•ï¼ˆAI Runtime è¯¦ç»†è®¾è®¡ï¼‰

### æ–°å¢ç« èŠ‚

- âœ… **å‘½ä»¤ç³»ç»Ÿ** - å…¨å±€å‘½ä»¤å’Œ Tab ç»‘å®šè§„åˆ™
- âœ… **Session ç®¡ç†ç­–ç•¥** - å…¨å±€å…±äº«å’Œ Fork è§„åˆ™

---

## ğŸ“ å¾…åŠäº‹é¡¹

### ç«‹å³

- [ ] å¼€å§‹ Phase 0 - ç¡®è®¤æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] è®°å½•æµ‹è¯•å¿«ç…§

### åç»­

- [ ] åœ¨å®ç°è¿‡ç¨‹ä¸­ç»†åŒ–æ¯ä¸ª Phase çš„è¯¦ç»†æ­¥éª¤
- [ ] æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´æ—¶é—´ä¼°è®¡

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

1. **ç®€åŒ–ä¼˜å…ˆ** - ç§»é™¤ä¸å¿…è¦çš„å¤æ‚åº¦ï¼ˆTurbo, ai-runtime, æ€§èƒ½æµ‹è¯•ï¼‰
2. **ä¿æŒä¸€è‡´** - ä¸ç°æœ‰è¡Œä¸ºä¿æŒä¸€è‡´ï¼ˆå‘½ä»¤ã€æ„å»ºï¼‰
3. **çµæ´»å¯é…** - æ”¯æŒé…ç½®ï¼ˆmaxFrozenMessagesï¼‰ä½†æœ‰åˆç†é»˜è®¤å€¼
4. **æ¸…æ™°è¾¹ç•Œ** - Agent å›ºå®šç»‘å®šï¼Œé€šè¿‡å‘½ä»¤çµæ´»åˆ‡æ¢

### å…³é”®æ”¶ç›Š

- âœ… å‡å°‘ 1 å‘¨å¼€å‘æ—¶é—´ï¼ˆ3 å‘¨ vs 4 å‘¨ï¼‰
- âœ… é™ä½æ¶æ„å¤æ‚åº¦ï¼ˆ6 ä¸ª package vs 7 ä¸ªï¼‰
- âœ… ç®€åŒ–ç±»å‹ç³»ç»Ÿï¼ˆ2 ç§ Tab vs 3 ç§ï¼‰
- âœ… ä¿æŒæµ‹è¯•ç®€å•ï¼ˆåŠŸèƒ½æµ‹è¯• vs æ€§èƒ½æµ‹è¯•ï¼‰
- âœ… æ˜ç¡® Session ç­–ç•¥ï¼ˆå…¨å±€å…±äº« + åå° Forkï¼‰

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²ç¡®è®¤æ— æ­§ä¹‰  
**ä¸‹ä¸€æ­¥**: å¼€å§‹ Phase 0 - å»ºç«‹æµ‹è¯•åŸºå‡†


