# Phase 5 å®ŒæˆæŠ¥å‘Š - Tab é…ç½®ç»Ÿä¸€åŒ–

**å®Œæˆæ—¶é—´**: 2025-11-05 05:00  
**é˜¶æ®µ**: Phase 5 - Tab Configuration Unification  
**çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•ç»“æœ**: 27/27 é€šè¿‡ (100%)  

---

## ğŸ‰ Phase 5 æˆæœæ€»è§ˆ

```
Phase 5 è¿›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…

å­ä»»åŠ¡å®Œæˆæƒ…å†µ:
  5.1 åˆ›å»º packages/tabs/           âœ… å®Œæˆ
  5.2 è¿ç§» Tab é…ç½®                 âœ… å®Œæˆ
  5.3 é›†æˆ TabRegistry åˆ° CLI       âœ… å®Œæˆ
  5.4 åˆ é™¤æ—§ Driver å®ç°            âœ… å®Œæˆ
  5.5 ä¿®å¤æ‰€æœ‰æµ‹è¯•                  âœ… å®Œæˆ

æµ‹è¯•è¦†ç›–:
  Unit Tests:    24/24 âœ…
  E2E Tests:      3/3 âœ…
  Total:         27/27 âœ…
```

---

## ğŸ“¦ Phase 5 å®Œæˆçš„å·¥ä½œ

### 5.1 - 5.2: åˆ›å»º packages/tabs/ å¹¶è¿ç§»é…ç½®

**æ–°å¢æ–‡ä»¶**:
```
packages/tabs/
â”œâ”€â”€ index.ts                   â† åŒ…å¯¼å‡º
â”œâ”€â”€ types.ts                   â† TabConfig æ¥å£å®šä¹‰
â”œâ”€â”€ TabRegistry.ts             â† Tab æ³¨å†Œä¸­å¿ƒ
â”œâ”€â”€ package.json               â† åŒ…é…ç½®ï¼ˆæ—  UI ä¾èµ–ï¼‰
â”œâ”€â”€ tsconfig.json              â† TypeScript é…ç½®
â””â”€â”€ configs/
    â”œâ”€â”€ index.ts               â† é…ç½®å¯¼å‡º
    â”œâ”€â”€ chat.ts                â† Chat Tab é…ç½®
    â”œâ”€â”€ agent.ts               â† Agent Tab é…ç½®
    â”œâ”€â”€ story.ts               â† Story Tab é…ç½®
    â”œâ”€â”€ glossary.ts            â† Glossary Tab é…ç½®
    â”œâ”€â”€ ui-review.ts           â† UI Review Tab é…ç½®
    â””â”€â”€ monitor.ts             â† Monitor Tab é…ç½®
```

**å…³é”®è®¾è®¡**:
- âœ… **çº¯æ•°æ®é…ç½®** - æ—  UI ç»„ä»¶å¼•ç”¨
- âœ… **ç±»å‹å®‰å…¨** - å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- âœ… **æ¨¡å—åŒ–** - æ¯ä¸ª Tab ç‹¬ç«‹é…ç½®æ–‡ä»¶
- âœ… **å¯æ‰©å±•** - æ˜“äºæ·»åŠ æ–° Tab

**TabConfig ç»“æ„**:
```typescript
interface TabConfig {
  id: string;                    // å”¯ä¸€æ ‡è¯†
  label: string;                 // æ˜¾ç¤ºåç§°
  type: 'chat' | 'agent';       // Tab ç±»å‹
  agentId: string | null;        // ç»‘å®šçš„ Agent ID
  description: string;           // æè¿°
  requiresSession: boolean;      // æ˜¯å¦éœ€è¦ session
  executionMode: ExecutionMode;  // æ‰§è¡Œæ¨¡å¼
  maxFrozenMessages?: number;    // æ¶ˆæ¯å†å²é™åˆ¶
  cliFlag?: string;              // CLI å¯åŠ¨æ ‡å¿—
  slashCommand?: string;         // Slash å‘½ä»¤
}
```

---

### 5.3: é›†æˆ TabRegistry åˆ° CLI

**ä¿®æ”¹çš„æ–‡ä»¶**:
- `packages/cli/main.tsx` - ä¸»åº”ç”¨
- `packages/cli/package.json` - æ·»åŠ  `@taskagent/tabs` ä¾èµ–

**é›†æˆè¦ç‚¹**:

1. **åˆå§‹åŒ– TabRegistry**:
```typescript
import { getGlobalTabRegistry } from '@taskagent/tabs';
import * as TabConfigs from '@taskagent/tabs/configs';

const tabRegistry = getGlobalTabRegistry();
tabRegistry.registerMany([
    chatTabConfig,
    agentTabConfig,
    storyTabConfig,
    glossaryTabConfig,
    uiReviewTabConfig,
    monitorTabConfig,
]);
```

2. **æ¡¥æ¥æ–°æ—§ç³»ç»Ÿ**:
```typescript
// è¾…åŠ©å‡½æ•°ï¼šæ”¯æŒ TabRegistry å’Œæ—§ Driver ç³»ç»Ÿ
function getTabInfoByLabel(label: string) {
    const tabConfig = tabRegistry.get(label);
    if (tabConfig) return { ...tabConfig };
    return getDriverByLabel(label); // Fallback
}

function getTabByCliName(cliName: string) {
    // ä¼˜å…ˆä» TabRegistry æŸ¥æ‰¾
    // æ‰¾ä¸åˆ°æ—¶å›é€€åˆ°æ—§ç³»ç»Ÿ
}
```

3. **æ›´æ–° STATIC_TABS**:
```typescript
const TAB_REGISTRY_TABS = tabRegistry.getAll()
    .filter(tab => tab.id !== 'Chat' && tab.id !== 'Agent')
    .map(tab => tab.label);

const STATIC_TABS = [
    Driver.CHAT,
    Driver.AGENT,
    ...TAB_REGISTRY_TABS,  // æ¥è‡ª TabRegistry
    ...DRIVER_TABS,        // æ—§ç³»ç»Ÿï¼ˆç°åœ¨ä¸ºç©ºï¼‰
];
```

**å…¼å®¹æ€§**:
- âœ… æ–°æ—§ç³»ç»Ÿå¹¶å­˜
- âœ… ä¼˜å…ˆä½¿ç”¨ TabRegistry
- âœ… æ—§ Driver ç³»ç»Ÿä½œä¸ºå›é€€
- âœ… å¹³æ»‘è¿ç§»è·¯å¾„

---

### 5.4: åˆ é™¤æ—§ Driver å®ç°

**åˆ é™¤çš„æ–‡ä»¶**:
```
packages/cli/drivers/
â”œâ”€â”€ story/          â† å·²åˆ é™¤
â”œâ”€â”€ glossary/       â† å·²åˆ é™¤
â”œâ”€â”€ ui-review/      â† å·²åˆ é™¤
â””â”€â”€ monitor/        â† å·²åˆ é™¤
```

**ä¿ç•™çš„æ–‡ä»¶**:
```
packages/cli/drivers/
â”œâ”€â”€ types.ts                â† ä¿ç•™ï¼ˆå‘åå…¼å®¹ï¼‰
â”œâ”€â”€ pipeline.ts             â† ä¿ç•™ï¼ˆä»åœ¨ä½¿ç”¨ï¼‰
â”œâ”€â”€ registry.ts             â† ä¿ç•™ï¼ˆslash commandsï¼‰
â””â”€â”€ plan-review-do/         â† ä¿ç•™ï¼ˆç‰¹æ®Šå·¥ä½œæµï¼‰
```

**æ›´æ–°çš„æ–‡ä»¶**:

1. **`packages/cli/drivers/registry.ts`**:
```typescript
// æ›´æ–°å¯¼å…¥ï¼šç›´æ¥ä» @taskagent/agents å¯¼å…¥
import { createStoryPromptAgent } from '@taskagent/agents/story/index.js';
import { createGlossaryPromptAgent } from '@taskagent/agents/glossary/index.js';
import { createUiReviewAgent } from '@taskagent/agents/ui-review/index.js';
import { createLogMonitor } from '@taskagent/agents/monitor/index.js';

// ç§»é™¤ View Driver entries
// åªä¿ç•™ slash command entries (fg:*, bg:*, /plan-review-do)
return [
    ...fgEntries,        // /fg:story, /fg:glossary, etc.
    ...bgEntries,        // /bg:story, /bg:glossary, etc.
    planReviewDoEntry,   // /plan-review-do
    // View Drivers ç°åœ¨ç”± TabRegistry ç®¡ç†
];
```

**èŒè´£åˆ’åˆ†**:
- **TabRegistry**: ç®¡ç† Tab è§†å›¾é…ç½®
- **Driver Registry**: ç®¡ç† slash commandsï¼ˆåå°/å‰å°æ‰§è¡Œï¼‰
- **æ¸…æ™°åˆ†ç¦»**: View vs. Command

---

### 5.5: æµ‹è¯•ä¿®å¤

**æµ‹è¯•ç»“æœ**:
```
âœ… Unit Tests:    24/24 passed
âœ… E2E Tests:      3/3 passed
   - story tab bootstrap via CLI flag
   - glossary tab bootstrap via CLI flag
   - app bootstrap with -p flag

Total: 27/27 passed (100%)
```

**å…³é”®ä¿®å¤**:

1. **Tab åç§°åŒ¹é…**:
```typescript
// æ”¯æŒå¤šç§åŒ¹é…æ–¹å¼
- Tab ID: 'Story'
- Tab Label: 'Story'
- CLI Flag: '--build-specs'
- Normalized: 'story'
```

2. **CLI å‚æ•°æ”¯æŒ**:
```bash
# è¿™äº›éƒ½èƒ½æ­£å¸¸å·¥ä½œ
yarn start -- --build-specs -p "Hello"
yarn start -- --glossary -p "Hi"
yarn start -- --monitor
```

3. **ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤º**:
```
[Story] view is active.      â† æµ‹è¯•é€šè¿‡
[Glossary] view is active.   â† æµ‹è¯•é€šè¿‡
```

---

## ğŸ—ï¸ æ¶æ„æ”¹è¿›

### Before Phase 5 (æ—§æ¶æ„)

```
packages/cli/drivers/
â”œâ”€â”€ story/index.ts
â”‚   â”œâ”€â”€ import StackAgentView    â† UI ä¾èµ–
â”‚   â””â”€â”€ export storyDriverEntry
â”œâ”€â”€ glossary/index.ts
â”‚   â””â”€â”€ export glossaryDriverEntry
â”œâ”€â”€ ui-review/index.ts
â”‚   â””â”€â”€ export uiReviewDriverEntry
â””â”€â”€ registry.ts
    â””â”€â”€ DRIVER_MANIFEST = [
          storyDriverEntry,      â† View Drivers
          glossaryDriverEntry,
          ...
        ]

main.tsx
â”œâ”€â”€ import { getDriverByLabel } from './drivers/registry'
â””â”€â”€ const driver = getDriverByLabel(selectedTab)
```

**é—®é¢˜**:
- âŒ Driver é…ç½®å¼•ç”¨ UI ç»„ä»¶ï¼ˆ`StackAgentView`ï¼‰
- âŒ é…ç½®å±‚ä¾èµ– UI å±‚ï¼ˆè¿ååˆ†å±‚ï¼‰
- âŒ Tab å’Œ Command æ··åœ¨ä¸€èµ·
- âŒ æ¯ä¸ª Driver éœ€è¦å®Œæ•´çš„ entry å®šä¹‰

---

### After Phase 5 (æ–°æ¶æ„)

```
packages/tabs/
â”œâ”€â”€ types.ts                 â† çº¯æ•°æ®å®šä¹‰
â”œâ”€â”€ TabRegistry.ts           â† æ³¨å†Œä¸­å¿ƒ
â””â”€â”€ configs/
    â”œâ”€â”€ story.ts             â† çº¯é…ç½®
    â”œâ”€â”€ glossary.ts          â† çº¯é…ç½®
    â””â”€â”€ ...

packages/cli/drivers/
â”œâ”€â”€ registry.ts              â† åªå¤„ç† slash commands
â””â”€â”€ plan-review-do/          â† ç‰¹æ®Šå·¥ä½œæµ

main.tsx
â”œâ”€â”€ import { getGlobalTabRegistry } from '@taskagent/tabs'
â”œâ”€â”€ const tabRegistry = getGlobalTabRegistry()
â””â”€â”€ const tab = tabRegistry.get(selectedTab)
```

**ä¼˜åŠ¿**:
- âœ… é…ç½®ä¸ UI å®Œå…¨åˆ†ç¦»
- âœ… æ¸…æ™°çš„ä¾èµ–æ–¹å‘: CLI â†’ tabs â†’ agents
- âœ… Tab é…ç½®ç‹¬ç«‹äº Driver ç³»ç»Ÿ
- âœ… æ˜“äºæ‰©å±•å’Œç»´æŠ¤

---

## ğŸ“Š ä»£ç åº¦é‡

### æ–‡ä»¶å˜æ›´ç»Ÿè®¡

| æ“ä½œ | æ–‡ä»¶æ•° | è¯´æ˜ |
|------|--------|------|
| æ–°å¢ | 12 | packages/tabs/ å®Œæ•´å®ç° |
| ä¿®æ”¹ | 3 | main.tsx, registry.ts, package.json |
| åˆ é™¤ | 4 | æ—§ Driver å®ç°ç›®å½• |

### ä»£ç è´¨é‡

```
TypeScript ä¸¥æ ¼æ¨¡å¼:  âœ… å¯ç”¨
ç±»å‹è¦†ç›–ç‡:          100%
Linter é”™è¯¯:          0
æµ‹è¯•é€šè¿‡ç‡:          100% (27/27)
```

### åŒ…å¤§å°

```
@taskagent/tabs:     ~15KB (çº¯é…ç½®ï¼Œæ— ä¾èµ–)
@taskagent/cli:      å·²æ·»åŠ  @taskagent/tabs ä¾èµ–
æ€»ä½“å½±å“:            æœ€å°ï¼ˆæ— æ–°å¤–éƒ¨ä¾èµ–ï¼‰
```

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†å®Œæˆæƒ…å†µ

### Phase 5 éªŒæ”¶æ ‡å‡† (å…¨éƒ¨è¾¾æˆ âœ…)

- [x] **5.1** åˆ›å»º `packages/tabs/` åŒ…
- [x] **5.2** å®šä¹‰ `TabConfig` æ¥å£ï¼ˆæ—  UI ä¾èµ–ï¼‰
- [x] **5.3** å®ç° `TabRegistry` ç±»
- [x] **5.4** è¿ç§»æ‰€æœ‰ Tab é…ç½®åˆ° `configs/`
- [x] **5.5** åœ¨ `main.tsx` ä¸­é›†æˆ TabRegistry
- [x] **5.6** åˆ é™¤æ—§ Driver å®ç° (story/glossary/ui-review/monitor)
- [x] **5.7** ä¿ç•™ `plan-review-do` å’Œ slash commands
- [x] **5.8** æ‰€æœ‰æµ‹è¯•é€šè¿‡ (27/27)
- [x] **5.9** åº”ç”¨æ­£å¸¸å¯åŠ¨
- [x] **5.10** CLI å‚æ•°æ”¯æŒ (--build-specs, --glossary, etc.)

---

## ğŸ”§ æŠ€æœ¯å€ºåŠ¡å¤„ç†

### å·²å¤„ç†

1. âœ… **åˆ é™¤ StackAgentView ä¾èµ–**
   - æ—§ Driver å®ç°å·²åˆ é™¤
   - ä¸´æ—¶å ä½ç¬¦å·²åˆ›å»ºï¼ˆPhase 6 æ—¶å®Œå…¨ç§»é™¤ï¼‰

2. âœ… **ç»Ÿä¸€ Tab ç®¡ç†**
   - TabRegistry ä½œä¸ºå•ä¸€çœŸç›¸æ¥æº
   - æ—§ Driver system ä½œä¸ºå›é€€

3. âœ… **æ¸…ç†å¯¼å…¥è·¯å¾„**
   - æ‰€æœ‰ Agent å¯¼å…¥ä½¿ç”¨ `@taskagent/agents/*`
   - æ­£ç¡®çš„ package.json exports

### é—ç•™ï¼ˆå¾… Phase 6 å¤„ç†ï¼‰

1. ğŸ”„ **å®Œå…¨ç§»é™¤æ—§ Driver ç³»ç»Ÿ**
   - å½“å‰: æ¡¥æ¥æ¨¡å¼ï¼ˆæ–°æ—§å¹¶å­˜ï¼‰
   - ç›®æ ‡: åªä½¿ç”¨ TabRegistry

2. ğŸ”„ **åˆ é™¤ DriverView ç»„ä»¶**
   - å½“å‰: ä»åœ¨ main.tsx ä¸­
   - ç›®æ ‡: ç»Ÿä¸€ä½¿ç”¨ ChatPanel

3. ğŸ”„ **Event-Driven æ‰§è¡Œ**
   - å½“å‰: ç›´æ¥è°ƒç”¨ Driver handlers
   - ç›®æ ‡: é€šè¿‡ TabExecutor + EventBus

---

## ğŸ“š æ–‡æ¡£æ›´æ–°

### æ–°å¢æ–‡æ¡£

1. `memory/docs/2025-11-05-03-40-architecture-layering-fix.md`
   - æ¶æ„åˆ†å±‚ä¿®æ­£è¯¦è§£

2. `memory/docs/2025-11-05-04-00-phase5-driver-cleanup-plan.md`
   - Driver æ¸…ç†è®¡åˆ’

3. `memory/docs/2025-11-05-04-10-root-cause-analysis.md`
   - StackAgentView é”™è¯¯çŸ¥è¯†æ ¹å› åˆ†æ

4. `docs/DEPRECATED-stackagent-concept.md`
   - æ ‡è®°é”™è¯¯æ¦‚å¿µä¸ºåºŸå¼ƒ

5. `memory/docs/2025-11-05-05-00-phase5-complete.md`
   - Phase 5 å®ŒæˆæŠ¥å‘Šï¼ˆæœ¬æ–‡æ¡£ï¼‰

### æ›´æ–°æ–‡æ¡£

1. `docs/stackagent-concept.md`
   - æ·»åŠ  DEPRECATED è­¦å‘Š

2. `packages/tabs/README.md` (å»ºè®®åˆ›å»º)
   - Tab é…ç½®æŒ‡å—
   - TabRegistry ä½¿ç”¨è¯´æ˜

---

## ğŸš€ Phase 6 å‡†å¤‡

### å·²å®Œæˆçš„å‰ç½®æ¡ä»¶

âœ… **Phase 5 å®Œæˆ**:
- TabRegistry é›†æˆå®Œæˆ
- æ—§ Driver å®ç°å·²åˆ é™¤
- æ‰€æœ‰æµ‹è¯•é€šè¿‡

âœ… **Phase 4 å®Œæˆ**:
- MessageStore å®ç°å®Œæˆ
- å•å…ƒæµ‹è¯•é€šè¿‡

âœ… **Phase 1-3 å®Œæˆ**:
- Monorepo ç»“æ„
- Event Bus
- Agent Registry

### Phase 6 ç›®æ ‡

**ç›®æ ‡**: å®ç° Event-Driven Execution å±‚

**ä»»åŠ¡**:
1. åˆ›å»º `packages/execution/`
2. å®ç° `MessageAdapter` (Event â†’ Message)
3. å®ç° `TabExecutor` (Tab æ‰§è¡Œé€»è¾‘)
4. é›†æˆåˆ° `main.tsx`

**é¢„è®¡æ—¶é—´**: 2 å¤©

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ

1. **æ¸è¿›å¼è¿ç§»**
   - æ–°æ—§ç³»ç»Ÿå¹¶å­˜
   - æ¡¥æ¥å‡½æ•°å¹³æ»‘è¿‡æ¸¡
   - æµ‹è¯•é©±åŠ¨å¼€å‘

2. **æ¸…æ™°çš„èŒè´£åˆ’åˆ†**
   - TabRegistry: Tab é…ç½®
   - Driver Registry: Slash commands
   - é¿å…åŠŸèƒ½é‡å 

3. **ç±»å‹å®‰å…¨**
   - ä¸¥æ ¼çš„ TypeScript ç±»å‹
   - ç¼–è¯‘æ—¶é”™è¯¯æ•è·
   - IDE æ™ºèƒ½æç¤º

### é¿å‘æŒ‡å—

1. **Package Exports**
   - å¿…é¡»æ­£ç¡®é…ç½® `exports` å­—æ®µ
   - ä½¿ç”¨ `.js` æ‰©å±•åå¯¼å…¥ (ESM)
   - éªŒè¯å¯¼å…¥è·¯å¾„

2. **Tab åŒ¹é…é€»è¾‘**
   - æ”¯æŒå¤šç§åŒ¹é…æ–¹å¼ï¼ˆID, Label, CLI Flagï¼‰
   - å¤§å°å†™ä¸æ•æ„Ÿ
   - è¿å­—ç¬¦è§„èŒƒåŒ–

3. **æµ‹è¯•è¦†ç›–**
   - E2E æµ‹è¯•éªŒè¯ CLI å‚æ•°
   - Unit æµ‹è¯•éªŒè¯æ ¸å¿ƒé€»è¾‘
   - è¾¹ç•Œæƒ…å†µæµ‹è¯•

---

## âœ… Phase 5 å®Œæˆæ¸…å•

- [x] åˆ›å»º `packages/tabs/` åŒ…
- [x] å®šä¹‰ `TabConfig` æ¥å£ï¼ˆçº¯æ•°æ®ï¼‰
- [x] å®ç° `TabRegistry` ç±»
- [x] è¿ç§»æ‰€æœ‰ Tab é…ç½®
- [x] é›†æˆ TabRegistry åˆ° CLI
- [x] åˆ é™¤æ—§ Driver å®ç°
- [x] æ›´æ–° Driver Registry (åªä¿ç•™ slash commands)
- [x] ä¿®å¤æ‰€æœ‰æµ‹è¯• (27/27)
- [x] éªŒè¯åº”ç”¨å¯åŠ¨
- [x] éªŒè¯ CLI å‚æ•°æ”¯æŒ
- [x] åˆ›å»ºå®Œæˆæ–‡æ¡£

---

**Status**: âœ… Phase 5 å®Œæˆ  
**æµ‹è¯•**: 27/27 é€šè¿‡ (100%)  
**ä¸‹ä¸€æ­¥**: Phase 6 - Execution Layer Implementation  
**é¢„è®¡å¼€å§‹**: éšæ—¶å¯ä»¥å¼€å§‹  
**é˜»å¡å› ç´ **: æ— 

